---
title: "Flares and pollutants - data prep"
author: "Meredith Franklin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(geosphere)
library(circular)
library(lwgeom)
library(sf)
library(units)

wd<-'/Users/meredith/Library/CloudStorage/GoogleDrive-mereditf@usc.edu/Shared drives/HEI Energy/flaring/new-git/STA496-UOGD'
#wd <- ''
```

## Data
- gather hourly (VOC matched) trailer data, subset to components related to flaring
- compute daily and nightly averages to match with flaring data
- merge enverus data and new VNF
- include NMF factors


#### Trailer data
```{r}
#trailer_hourly <- readRDS('../../DataProcessing/TrailerProcessed-20240601.rds')
#trailer_hourly <- readRDS('/Users/meredith/Library/CloudStorage/GoogleDrive-mereditf@usc.edu/Shared drives/HEI Energy/flaring/STA496-UOGD/STA496-UOGD/DataProcessing/TrailerProcessed-20240601.rds')
trailer_hourly <-readRDS(paste0(wd,"/data/processed_data/Trailer_hourly_merge_20250909.rds"))
trailer_hourly$total_radioactivity<-trailer_hourly$radon_B+trailer_hourly$rd_particle_B
trailer_hourly<-trailer_hourly[trailer_hourly$`1_3-butadiene`<=0.1,]
```


```{r}
columns <- c('time_utc', 'ch4', 'co', 'co2_ppm', 'h2s','so2','nox', 'benzene', 'ethene', '1_3-butadiene',
             'ethane', "total_radioactivity", 'wdr_deg', 'wsp_ms')

trailer_hourly_clean <- trailer_hourly %>% 
  dplyr::select(all_of(columns)) %>%
  rename('co2' = 'co2_ppm') %>%
  mutate(datetime_utc = as.POSIXct(time_utc, tz = 'UTC', format = "%Y-%m-%d %H:%M:%OS"),
         datetime_mountain = with_tz(as.POSIXct(time_utc, tz = 'UTC', format = "%Y-%m-%d %H:%M:%OS"), 
                                     tzone = "America/Denver")) %>%
  mutate(day_utc = as.Date(format(datetime_utc, '%Y-%m-%d')),
         day_mountain = as.Date(format(datetime_mountain, '%Y-%m-%d'))) 
```


```{r warning=FALSE, message=FALSE}
# Compute daily average
trailer_daily <- trailer_hourly_clean %>% 
  dplyr::select(-c(time_utc, day_utc, datetime_utc, datetime_mountain)) %>% 
  group_by(day_mountain) %>% 
  summarise(across(!wdr_deg, ~mean(.x, na.rm=T)),
            wdr_deg = as.numeric(mean(circular(wdr_deg, units = "degrees", template="geographics"), na.rm=T))) %>%
  mutate(wdr_deg = if_else(wdr_deg < 0, wdr_deg+360, wdr_deg))

# Compute nightly average measurement from 0am to 6am
trailer_night_avg <- trailer_hourly_clean %>% 
  filter(hour(ymd_hms(datetime_mountain)) <= 6) %>%
  dplyr::select(-c(time_utc, day_utc, datetime_utc, datetime_mountain)) %>% 
  group_by(day_mountain) %>% 
  summarise(across(everything(), ~mean(.x, na.rm=T))) %>%
  mutate(wdr_deg = if_else(wdr_deg < 0, wdr_deg+360, wdr_deg))
```


- Jerry: Need to add wind direction bins
- SE: 129–194° 
- SW: 212–258° 
- NW: 292–26° 

- Also add wind direction bins in the following:
Direction
Range (°)
N 337.5–360 & 0–22.5
NE 22.5–67.5
E 67.5–112.5
SE 112.5–157.5
S 157.5–202.5
SW 202.5–247.5
W 247.5–292.5
NW 292.5–337.5

Note from Jerry: I moved this part below the chunk above since we want bins for the averages
```{r}
# Since these 3 bins do not cover the entire 360 degrees,
# Create 3 binary variables for each bin, use these as predictors in regression 
# Baseline will be the complement (Neither of 3)
trailer_daily  <- trailer_daily %>%
  mutate(wind_SE = ifelse(between(wdr_deg, 129, 194), 1, 0),
         wind_SW = ifelse(between(wdr_deg, 212, 258), 1, 0),
         wind_NW = ifelse(between(wdr_deg, 292, 360) | 
                            between(wdr_deg, 0, 26), 1, 0))

trailer_night_avg  <- trailer_night_avg %>%
  mutate(wind_SE = ifelse(between(wdr_deg, 129, 194), 1, 0),
         wind_SW = ifelse(between(wdr_deg, 212, 258), 1, 0),
         wind_NW = ifelse(between(wdr_deg, 292, 360) | 
                            between(wdr_deg, 0, 26), 1, 0))
```

```{r}
# bin code sample, but edit as needed
bin_wind_dir <- function(deg) {
 cuts <- c(0, 22.5, 67.5, 112.5, 157.5, 202.5, 247.5, 292.5, 337.5, 360)
 labels <- c("N", "NE", "E", "SE", "S", "SW", "W", "NW", "N")
 cut(deg %% 360, breaks = cuts, labels = labels, include.lowest = TRUE, right = FALSE)
}
trailer_daily$wind_bin <- bin_wind_dir(trailer_daily$wdr_deg)
trailer_night_avg$wind_bin <- bin_wind_dir(trailer_night_avg$wdr_deg)
```

#### Well Data

- load processed well production data (monthly production values)
- the distance to the wells is computed with inverse distance 
- From enverus data up to 50 km around LNM and all drill types (V,H & D) oil separate from gas


```{r}
Wells <- readRDS(paste0(wd,"/data/processed_data/WellsProcessed20250909.rds"))
```

```{r}
radius <- c(5, 10, 20, 30, 40, 50)

for (i in seq_along(radius)) {
  if (i == 1) {
    wells_monthly <- Wells %>%
      filter(distToLovi <= radius[i]) %>%
      mutate(Month = format(as.Date(prod_date), "%Y-%m"),
             inv_dist_well = ifelse(1 / distToLovi < 0.01, 0, 1 / distToLovi)) %>%
      group_by(Month) %>%
      summarise(
        closest_well = min(distToLovi, na.rm = TRUE),
        mean_dist_well = mean(distToLovi, na.rm = TRUE),
        weighted_count_wells = sum(inv_dist_well, na.rm = TRUE) * 100,
        weighted_monthly_oil = sum(monthly_oil * inv_dist_well, na.rm = TRUE),
        weighted_monthly_gas = sum(monthly_gas * inv_dist_well, na.rm = TRUE),
        monthly_oil = sum(monthly_oil, na.rm = TRUE),
        monthly_gas = sum(monthly_gas, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      rename_with(~paste0(.x, "_", radius[i]), -Month)
    
  } else {
    wells_monthly <- left_join(
      wells_monthly,
      Wells %>%
        filter(distToLovi <= radius[i]) %>%
        mutate(Month = format(as.Date(prod_date), "%Y-%m"),
               inv_dist_well = ifelse(1 / distToLovi < 0.01, 0, 1 / distToLovi)) %>%
        group_by(Month) %>%
        summarise(
          closest_well = min(distToLovi, na.rm = TRUE),
          mean_dist_well = mean(distToLovi, na.rm = TRUE),
          weighted_count_wells = sum(inv_dist_well, na.rm = TRUE) * 100,
          weighted_monthly_oil = sum(monthly_oil * inv_dist_well, na.rm = TRUE),
          weighted_monthly_gas = sum(monthly_gas * inv_dist_well, na.rm = TRUE),
          monthly_oil = sum(monthly_oil, na.rm = TRUE),
          monthly_gas = sum(monthly_gas, na.rm = TRUE),
          .groups = "drop"
        ) %>%
        rename_with(~paste0(.x, "_", radius[i]), -Month),
      by = "Month"
    )
  }
}

```

#### Flare Data

- import processed v3.5 flaring data (NOTE to Jerry 7/16/2025: there is going to be new predicted methane_eq soon)
- remove noise -1 cluster
- calculate distance of flares to trailer
- subset within 50 km (smaller buffers done later)


```{r}
#flaring2 <- readRDS('FlaringProcessed.rds')

#flaring <-read.csv("../../data/pb_vnf/flaring_v35_clustered.csv")
#flaring <- readRDS(paste0(wd, "../data/processed_data/model_dataset_highest_train_r2.rds"))

flaring <- read.csv("/Users/meredith/Library/CloudStorage/GoogleDrive-mereditf@usc.edu/Shared drives/HEI Energy/data/vnf data/datasets/complete_datasets/imputed_hdbscan_dataset.csv")

flaring <- flaring %>%
  mutate(
    lon_m_utm13 = lon_km_utm13 * 1000,
    lat_m_utm13 = lat_km_utm13 * 1000
  ) %>%
  st_as_sf(coords = c("lon_m_utm13", "lat_m_utm13"), crs = 32613)

#flaring %>%
#  summarize(non_missing_temp_bb = sum(!is.na(methane_eq)))

flaring_ll <- st_transform(flaring, crs = 4326)
flaring_ll <- flaring_ll %>%
  mutate(
    lon = st_coordinates(.)[, 1],
    lat = st_coordinates(.)[, 2]
  )

flaring <- flaring_ll %>%
  st_transform(flaring_ll, crs = 32613) %>%
  mutate(date = as.Date(file_date))
```

```{r}
loving_lonlat <- c(-104.1089, 32.2961) 
loving_lonlat_sf <- st_sfc(st_point(loving_lonlat), crs = 4326) %>%
  st_transform(loving_lonlat_sf, crs=32613)

#flaring2 <- flaring2 %>%
#  st_as_sf(coords = c('lon', 'lat'), remove = F) %>%
#  st_set_crs(4326) %>%
#  st_transform(flaring2,crs=32613)

flaring_loving_50 <- flaring %>% 
  mutate(distToLovi_flare = c(drop_units(st_distance(flaring, loving_lonlat_sf)))/1000) %>% 
  st_drop_geometry() %>%
  dplyr::select(c("date", "distToLovi_flare",  "methane_eq", "imputed_methane_eq", "lon", "lat")) %>% 
  filter(distToLovi_flare <= 50)
```

#### Create daily flare data

- create counts of flares by buffer
- take mean by date of the VNF params including predicted methane_eq

- Also try idw weighted flares and methane_eq

```{r}
flaring_daily <- flaring_loving_50 %>% 
  mutate(inv_dist = ifelse(1 / distToLovi_flare < 0.01, 0, 1 / distToLovi_flare)) %>%
  group_by(date) %>% 
  summarise(
    closest.flare = min(distToLovi_flare),
    distToLovi_flare_mean = mean(distToLovi_flare, na.rm=TRUE),
    inv_dist_mean = mean(inv_dist, na.rm=TRUE),
    
    # Weighted number of flares
    weighted.count = sum(inv_dist, na.rm=TRUE) * 100,
    
    n_flare_50 = n(),
    n_flare_40 = coalesce(sum(distToLovi_flare <= 40), 0),
    n_flare_30 = coalesce(sum(distToLovi_flare <= 30), 0),
    n_flare_20 = coalesce(sum(distToLovi_flare <= 20), 0),
    n_flare_10 = coalesce(sum(distToLovi_flare <= 10), 0),
    n_flare_5  = coalesce(sum(distToLovi_flare <= 5), 0),
    
    # Medians by buffer
    imputed_methane_eq_50 = median(imputed_methane_eq, na.rm=TRUE),
    imputed_methane_eq_40 = median(imputed_methane_eq[distToLovi_flare <= 40], na.rm=TRUE),
    imputed_methane_eq_30 = median(methane_eq[distToLovi_flare <= 30], na.rm=TRUE),
    imputed_methane_eq_20 = median(methane_eq[distToLovi_flare <= 20], na.rm=TRUE),
    imputed_methane_eq_10 = median(methane_eq[distToLovi_flare <= 10], na.rm=TRUE),
    imputed_methane_eq_5  = median(methane_eq[distToLovi_flare <= 5], na.rm=TRUE),
    methane_eq = median(methane_eq, na.rm=TRUE),
    
    # Inverse-distance-weighted averages
    idw_imputed_methane_eq = ifelse(sum(inv_dist, na.rm=TRUE) > 0,
                                    sum(imputed_methane_eq * inv_dist, na.rm=TRUE) / sum(inv_dist, na.rm=TRUE),
                                    NA_real_),
    idw_methane_eq = ifelse(sum(inv_dist, na.rm=TRUE) > 0,
                            sum(methane_eq * inv_dist, na.rm=TRUE) / sum(inv_dist, na.rm=TRUE),
                            NA_real_),
    
    # Inverse-distance-weighted totals (scaled by 100)
    idw_total_imputed_methane_eq = sum(imputed_methane_eq * inv_dist, na.rm=TRUE) * 100,
    idw_total_methane_eq = sum(methane_eq * inv_dist, na.rm=TRUE) * 100
  ) %>%
  rename(distToLovi_flare = distToLovi_flare_mean)
```


```{r}
# Notice that if there's no flare in a given night, there's no row for that day.
# Hence, we will fill out these days with n_flare variables to 0 and rest to NA
flaring_daily <- flaring_daily %>%
  bind_rows(
    tibble(date = as.Date(setdiff(seq(as.Date("2023-05-01"), as.Date("2024-06-01"), by = 'day'), flaring_daily$date)),
           n_flare_50 = 0,
           n_flare_40 = 0,
           n_flare_30 = 0,
           n_flare_20 = 0,
           n_flare_10 = 0,
           n_flare_5 = 0,
           weighted.count = 0,
           methane_eq=0,
           idw_imputed_methane_eq=0,
           idw_methane_eq=0,
           idw_total_imputed_methane_eq=0,
           idw_total_methane_eq=0
           )
  ) %>%
  arrange(date)
```

```{r}
#unique nights per buffer
flaring_daily %>%
    filter(n_flare_50 != 0) %>%
    summarise(unique_days = n_distinct(as.Date(date)))
#num flares per buffer
sum(flaring_daily$n_flare_50)
sum(flaring_daily$n_flare_40)
sum(flaring_daily$n_flare_30)
sum(flaring_daily$n_flare_20)
sum(flaring_daily$n_flare_10)
sum(flaring_daily$n_flare_5)

```

```{r}
# Compute flare angle
angles <- tibble(st_sfc(st_point(loving_lonlat), crs = 4326), 
                 flaring_loving_50[,c('lon', 'lat')] %>% 
                   st_as_sf(coords = c('lon', 'lat')) %>% 
                   st_set_crs(4326)) %>%
                pivot_longer(cols = everything()) %>% 
                pull(value) %>% # extract coordinates only
                st_geod_azimuth() %>%
                set_units('degrees') %>% # convert to degrees
                drop_units()
angles <- angles[c(T, F)] # keep only odd index, valid pairs
angles <- if_else(angles < 0, angles + 360, angles)
flaring_loving_50$angle <- angles
```

#### NMF data

- merge in result from NMF 
- create hourly then daytime and nighttime averages
- updated to the 4-factor version

```{r}
#nmf_data <- readRDS('../../Model/result_rfiles/normalized_hourly_data_5c_less_o3.rds')
nmf_data <- readRDS(paste0(wd, '/Model/result_rfiles/normalized_hourly_data_5c_less_o3.rds'))

```


```{r}
nmf_factor_hourly <- nmf_data %>%
  dplyr::select(time_utc, Factor1, Factor2, Factor3, Factor4, Factor5) %>%
  mutate(datetime_mountain = with_tz(as.POSIXct(time_utc, tz = 'UTC', format = "%Y-%m-%d %H:%M:%OS"), 
                                     tzone = "America/Denver")) %>%
  mutate(day_mountain = as.Date(format(datetime_mountain, '%Y-%m-%d'))) %>%
  dplyr::select(-time_utc) %>%
  filter(if_all(everything(), ~!is.na(.)))
```

```{r}
nmf_factor_day <- nmf_factor_hourly %>% 
  dplyr::select(-datetime_mountain) %>%
  group_by(day_mountain) %>% 
  summarise(across(everything(), ~mean(.x, na.rm=T))) 

nmf_factor_night <- nmf_factor_hourly %>% 
  filter(hour(ymd_hms(datetime_mountain)) <= 6) %>%
  group_by(day_mountain) %>% 
  summarise(across(everything(), ~mean(.x, na.rm=T))) %>%
  dplyr::select(-datetime_mountain)
```


#### Merge full dataset
- merge all components
- create 5,10,20,30,40,50 km buffers

```{r}
# buffers
radius <- c(5, 10, 20, 30, 40, 50)

full_merged <- trailer_daily %>%
  left_join(trailer_night_avg, 
            join_by(day_mountain), 
            suffix = c('.day', '.night')) %>%
  left_join(flaring_daily, 
            join_by(day_mountain==date)) %>%
  mutate(yearmonth = format(day_mountain, '%Y-%m')) %>%
  left_join(wells_monthly, join_by(yearmonth == Month)) %>%
  left_join(nmf_factor_day, join_by(day_mountain)) %>%
  left_join(nmf_factor_night, join_by(day_mountain), 
              suffix = c('.day', '.night'))

# Add the flare downwind variables

for (r in radius) {
  
  temp <- flaring_loving_50 %>%
    filter(distToLovi_flare <= r)
    
  new_colnames <- paste0(c('flare_wd_day_', 'flare_wd_night_'), r)
  
  # Create number of flares in upwind direction day and night.
  flare_is_from_wd <- temp %>% 
    left_join(trailer_daily, join_by(date==day_mountain)) %>%
    left_join(trailer_night_avg, join_by(date==day_mountain), 
              suffix = c('.day', '.night')) %>%
  group_by(date) %>%
  summarise(flare_wd_day = sum(abs(angle - wdr_deg.day) <= 30, na.rm=T),
            flare_wd_night = sum(abs(angle - wdr_deg.night) <= 30, na.rm=T)) %>%
  rename(setNames(c('flare_wd_day', 'flare_wd_night'), new_colnames))
  
full_merged <- full_merged %>%
  left_join(flare_is_from_wd, join_by(day_mountain == date)) %>%
  mutate(across(all_of(new_colnames), ~ coalesce(., 0)))
}
```

- From here, use `full_merged` for models
- Filter to May 1, 2023 through May 31, 2024 for final analysis

```{r}
full_merged <- full_merged %>%
  filter(day_mountain >= as.Date("2023-05-01"))

write.csv(full_merged, paste0(wd, "/data/processed_data/full_data_for_regressions.csv"), row.names=FALSE)
#write.csv(full_merged, "table6_new.csv", row.names=FALSE)
```
