---
title: "TrailerProcess"
author: "William Zhang"
date: "2023-09-28"
output: html_document
---
```{r, include=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(geosphere)
library(leaflet)
library(leaflet.extras)
library(lubridate)
library(lmtest)
library(vip)
library(car)
library(mgcv)
```

# Loading and Merging dataset
## Trailer data
### Reading the datasets
```{r}
# current version q3
base_dir <- "../data/trailer03292024/"
folders <- list.dirs(base_dir)

for (folder in folders[-1]) {
    # Construct the file path
    file_dirs <- list.files(folder)
    for (file in file_dirs) {
      file_dir <- paste0(folder, '/', file)
      assign(paste0(file), read.csv(file_dir, skip=1, header=TRUE))
    }
}
```
### Data processing
```{r}
pol_cat_names <- c("bc", "rd", "co", "nox", "o3", "met", "ch4", "h2s", "voc")

my_mean <- function(x){
  mean(x, na.rm=TRUE)
}

for (pol in pol_cat_names){
  data_names <- objects(pattern = paste0('LNM_', pol))
  
  data_full <- tibble()
  for (data_name in data_names) {
    data_full <- rbind(data_full, get(data_name))
  }
  
  # Convert to standard time format
  data_full$std_time <- as_datetime(data_full$time, tz = "MST")
  
  data_full$time_hourly <- substr(format(data_full$std_time, format = "%Y-%m-%d %H:%M:%S"), 1, 13)
  exclude_vars <- c("std_time", "time")
  df_temporary_clean <- data_full %>% group_by(time_hourly) %>% summarize(across(
      .cols = -all_of(exclude_vars),  # Exclude specified variables
      .fns = my_mean  # Apply the my_mean function with na.rm=TRUE
    ))
  assign(paste0("df_", pol), df_temporary_clean, envir = .GlobalEnv)
}
```

### Data Merging
```{r}
df_trailer <- df_rd %>%
  full_join(df_co, by = 'time_hourly') %>%
  full_join(df_bc, by = 'time_hourly') %>%
  full_join(df_nox, by = 'time_hourly') %>%
  full_join(df_o3, by = 'time_hourly') %>%
  full_join(df_met, by = 'time_hourly') %>%
  full_join(df_ch4, by = 'time_hourly') %>%
  full_join(df_h2s, by = 'time_hourly') %>%
  full_join(df_voc, by = 'time_hourly')
```

```{r}
# add a hour variable
df_trailer$hour <- as.numeric(substr(df_trailer$time_hourly, 12, 13))
```
```{r}
# remove room_f, pump_f, sw_comp_purge
df_trailer <- df_trailer %>% select(-c(t_room_f, sw_comp_purge, t_pump_f))
```

```{r}
summary(df_trailer)
```


```{r}
# Saving
saveRDS(df_trailer, file = "TrailerProcessed.rds")
trailer_old <- readRDS("TrailerProcessed.rds")
```

