---
title: "Methane_comp"
author: "Jerry Wu"
date: "2025-01-07"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(geosphere)
```

```{r}
# Load in trailer Methane
Trailer <- readRDS('TrailerProcessed-20240601.rds')

trailer_ch4 <- Trailer %>% select(time_utc, ch4) %>%
  mutate(day = as.Date(format(as.POSIXct(time_utc), '%Y-%m-%d')))
```

```{r}
# Load in VNF data
vnf <- readRDS('pb-vnf_20230501-20240601.rds')

vnf <- vnf %>% 
  mutate(across(where(is.numeric),  ~ na_if(.x, 999999))) %>% # replace 999999 as missing
  filter(!(is.na(temp_bb) | is.na(methane_eq))) # keep those not missing temperature

vnf <- vnf %>%
  filter(temp_bb >= 1600)

loving_lonlat <- c(-104.1089, 32.2961)
distance_km_lov <- function(long, lati){
  start <- c(long, lati)
  distGeo(start, loving_lonlat) / 1000
}

vnf <- vnf %>% 
  mutate(distToLovi = mapply(distance_km_lov, lon, lat))

radius <- c(5, 10, 20, 50, 100)

methane_corr <- tibble(radius = radius, 
                       n = rep(0, length(radius)), 
                       correlation = rep(0, length(radius)))

for (r in radius) {
  temp <- vnf %>%
    filter(distToLovi <= r)
  
  merged_ch4 <- temp %>%
    select(date, methane_eq) %>%
    group_by(date) %>%
    summarise(avg_methane_eq = mean(methane_eq)) %>%
    left_join(trailer_ch4 %>% 
                select(day, ch4) %>% 
                group_by(day) %>% 
                summarise(avg_ch4 = mean(ch4, na.rm=T)), 
              join_by(date == day)) %>%
  rename('ch4_vnf' =  'avg_methane_eq', 
         'ch4_trailer' = 'avg_ch4')
  
  methane_corr <- methane_corr %>%
    rows_update(tibble(radius = r, 
                       n = nrow(merged_ch4),
                       correlation = cor(merged_ch4$ch4_vnf,
                                         merged_ch4$ch4_trailer)), by = 'radius')
}

methane_corr
```


```{r}
cor(merged_ch4$ch4_vnf_10km, merged_ch4$ch4_trailer, use = 'complete')

cor(merged_ch4$ch4_vnf_20km, merged_ch4$ch4_trailer, use = 'complete')
```



