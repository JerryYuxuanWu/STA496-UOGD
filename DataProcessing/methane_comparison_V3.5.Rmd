---
title: "Methanem Comparison"
author: "Jerry Wu"
date: "2025-01-09"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(geosphere)
```

```{r}
# Load in trailer Methane
Trailer <- readRDS('TrailerProcessed-20240601.rds')

trailer_ch4_CO_NOx_wind <- Trailer %>% select(time_utc, ch4, co, nox, wdr_deg, wsp_ms) %>%
  mutate(day = as.Date(format(as.POSIXct(time_utc), '%Y-%m-%d')))
```

```{r}
# Load in VNF data
vnf <- readRDS('pb-vnf_20230501-20240601.rds')

vnf <- vnf %>% 
  mutate(across(where(is.numeric),  ~ na_if(.x, 999999))) %>% # replace 999999 as missing
  filter(!(is.na(temp_bb) | is.na(methane_eq))) # keep those not missing temperature

vnf <- vnf %>%
  filter(temp_bb >= 1600)

loving_lonlat <- c(-104.1089, 32.2961)
distance_km_lov <- function(long, lati){
  start <- c(long, lati)
  distGeo(start, loving_lonlat) / 1000
}

vnf <- vnf %>% 
  mutate(distToLovi = mapply(distance_km_lov, lon, lat))

radius <- c(5, 10, 20, 50, 100)

trailer_compounds <- c('ch4', 'co', 'nox')

corr_result <- tibble(radius = numeric(), 
                      trailer_compound = character(),
                      corr = numeric())
for (r in radius) {
  temp <- vnf %>%
    filter(distToLovi <= r)
  
  merged <- temp %>%
    select(date, methane_eq) %>%
    group_by(date) %>%
    summarise(avg_methane_eq = mean(methane_eq)) %>%
    left_join(trailer_ch4_CO_NOx_wind %>% 
                select(-time_utc) %>% 
                group_by(day) %>% 
                summarise(across(everything(), ~mean(.x, na.rm=T))), 
              join_by(date == day)) %>%
  rename('ch4_vnf' =  'avg_methane_eq')
  
  corr <- tibble(trailer_compound = trailer_compounds, corr = sapply(trailer_compounds, function(x) cor(merged$ch4_vnf, merged%>%pull(x), use = 'complete')))
  
  corr_result <- corr_result %>%
    left_join(corr %>% mutate(radius = r), join_by(radius))
}

corr_result
```
```{r}

```





